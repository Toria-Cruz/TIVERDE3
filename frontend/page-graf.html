<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EcoTech — Painel</title>

  <!-- Fonts + Bootstrap + Icons + ChartJS -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Seu style principal (mantém tudo existente) -->
  <link rel="stylesheet" href="Css/style.css">

  <!-- Estilos adicionais: já inseridos no final do seu style.css (veja instrução abaixo) -->
</head>

<body class="page-graf">

  <div class="app-shell d-flex">

    <!-- ========== SIDEBAR FIXA ========== -->
    <aside class="sidebar d-flex flex-column">
      <a href="index.html" class="sidebar-top px-3 py-3 d-flex align-items-center gap-2 text-decoration-none">
        <img src="./img/ecotech-fundo.png" alt="logo" class="sidebar-logo">
        <div>
          <div class="brand-title">EcoTech</div>
          <small class="text-muted brand-sub">Energy Solutions</small>
        </div>
      </a>


      <nav class="nav flex-column sidebar-nav mt-3">
        <a class="nav-item active" href="#"><i class="bi bi-grid-fill me-2"></i>Visão Geral</a>
        <a class="nav-item" href="#"><i class="bi bi-bar-chart-line-fill me-2"></i>Análises</a>
        <a class="nav-item" href="#"><i class="bi bi-hdd-network-fill me-2"></i>Dispositivos</a>
        <a class="nav-item" href="#"><i class="bi bi-gear-fill me-2"></i>Configurações</a>
      </nav>

      <div class="sidebar-footer mt-auto px-3 py-3">
        <button id="collapseSidebarBtn" class="btn btn-sm btn-outline-secondary w-100 mb-2">
          <i class="bi bi-chevron-left"></i> Esconder
        </button>
        <div class="sidebar-help small text-muted">Precisa de ajuda? <a href="#" class="link-primary">Suporte</a></div>
      </div>
    </aside>

    <!-- ========== MAIN (HEADER + CONTENT) ========== -->
    <main class="content-area flex-fill">

      <!-- top header -->
      <header class="topbar d-flex align-items-center justify-content-between px-4 py-3 shadow-sm">
        <div class="d-flex align-items-center gap-3">
          <button id="openSidebarBtn" class="btn btn-light btn-sm d-md-none"><i class="bi bi-list"></i></button>
          <h6 class="mb-0 text-uppercase text-muted small">Painel • Visão Geral</h6>
        </div>

        <div class="d-flex align-items-center gap-3">
          <div class="input-group search-sm d-none d-md-flex">
            <span class="input-group-text bg-white border-0"><i class="bi bi-search"></i></span>
            <input class="form-control form-control-sm border-0" placeholder="Buscar..." aria-label="Buscar">
          </div>

          <div class="d-flex align-items-center gap-2">
            <!-- Botão de login (visível quando não logado) -->
            <a id="login-botao" href="#" class="btn btn-outline-success btn-sm d-none">
              Entrar
            </a>

            <!-- Dropdown do perfil (visível quando logado) -->
            <div class="dropdown" id="perfil-dropdown">
              <button class="btn btn-success dropdown-toggle btn-sm d-flex align-items-center gap-2" type="button"
                id="perfil-botao" data-bs-toggle="dropdown" aria-expanded="false">
                <img id="userAvatar" src="img/user.png" alt="avatar" class="avatar-sm rounded-circle">
                <span id="usernameLabel">Usuário</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="perfil-botao">
                <li><a class="dropdown-item" href="index.html">Página Inicial</a></li>
                <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Meu Perfil</a></li>
                <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Configurações</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="#" id="logout-btn"><i class="bi bi-box-arrow-right me-2"></i>Sair</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </header>

      <!-- page content -->
      <section class="px-4 py-4">

        <!-- KPI CARDS -->
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <div class="kpi-card p-3 d-flex align-items-center gap-3">
              <div class="kpi-icon bg-soft-success rounded-circle">
                <i class="bi bi-currency-dollar"></i>
              </div>
              <div class="kpi-body">
                <div class="kpi-label small text-muted">Custo Mensal</div>
                <div class="kpi-value h5 mb-0">R$ 1.234,56 <span class="badge bg-success ms-2">+5%</span></div>
                <div class="kpi-sub small text-muted">Comparado ao mês anterior</div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="kpi-card p-3 d-flex align-items-center gap-3">
              <div class="kpi-icon bg-soft-primary rounded-circle">
                <i class="bi bi-lightning-fill"></i>
              </div>
              <div class="kpi-body">
                <div class="kpi-label small text-muted">Consumo Atual</div>
                <div class="kpi-value h5 mb-0">32 kWh <span class="badge bg-info ms-2">Estável</span></div>
                <div class="kpi-sub small text-muted">Última atualização: 5 min</div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="kpi-card p-3 d-flex align-items-center gap-3">
              <div class="kpi-icon bg-soft-warning rounded-circle">
                <i class="bi bi-shield-lock-fill"></i>
              </div>
              <div class="kpi-body">
                <div class="kpi-label small text-muted">Economia</div>
                <div class="kpi-value h5 mb-0">18% <span class="badge bg-success ms-2">Bom</span></div>
                <div class="kpi-sub small text-muted">Meta: 20%</div>
              </div>
            </div>
          </div>
        </div>

        <!-- charts row -->
        <div class="row g-4 mb-4">
          <div class="col-lg-7">
            <div class="card h-100 p-3">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h6 class="mb-0">Consumo em kWh</h6>
                <div class="small text-muted">Ano <select id="ano-picker"
                    class="form-select form-select-sm d-inline-block ms-2" style="width:110px"></select></div>
              </div>
              <div style="min-height:260px">
                <canvas id="consumoChart"></canvas>
              </div>
            </div>
          </div>

          <div class="col-lg-5">
            <div class="card h-100 p-3">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h6 class="mb-0">Consumo por Tipo</h6>
                <div class="small text-muted">Mês <select id="ano-picker-pizza"
                    class="form-select form-select-sm d-inline-block ms-2" style="width:110px"></select></div>
              </div>
              <div class="d-flex align-items-center justify-content-center" style="min-height:260px">
                <canvas id="consumoTipoChart" style="max-width:260px;"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- devices + table -->
        <div class="row g-4">
          <div class="col-xl-5">
            <div class="card p-3 h-100">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h6 class="mb-0">Dispositivos</h6>
                <small class="text-muted">Lista ativa</small>
              </div>
              <div id="device-list" class="device-list">
                <!-- JS will inject list -->
              </div>
            </div>
          </div>

          <div class="col-xl-7">
            <div class="card p-3 h-100">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h6 class="mb-0">Consumo mensal (tabela)</h6>
                <div>
                  <select id="mes-info-tabela" class="form-select form-select-sm d-inline-block" style="width:140px">
                    <option value="">Mês</option>
                    <option>Janeiro</option>
                    <option>Fevereiro</option>
                    <option>Março</option>
                  </select>
                  <select id="ano-info-tabela" class="form-select form-select-sm d-inline-block ms-2"
                    style="width:120px">
                    <option>Ano</option>
                    <option>2025</option>
                    <option>2024</option>
                  </select>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Dispositivo</th>
                      <th>Consumo (kWh)</th>
                      <th>Status</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="tabela-info">
                    <!-- JS inject -->
                  </tbody>
                </table>
              </div>

            </div>
          </div>
        </div>

      </section>


    </main>

  </div>

  <!-- ========== SCRIPTS ========== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* =========================
       UI: perfil / logout / sidebar - CORRIGIDO
       ========================= */
    (function () {
      const loginBtn = document.getElementById("login-botao");
      const perfilDropdown = document.getElementById("perfil-dropdown");
      const logoutBtn = document.getElementById("logout-btn");
      const usernameLabel = document.getElementById("usernameLabel");

      // Função para verificar e atualizar estado de login
      function atualizarEstadoLogin() {
        try {
          const usuarioLogado = JSON.parse(sessionStorage.getItem("usuarioLogado"));
          console.log("Usuário logado (page-graf):", usuarioLogado);

          if (usuarioLogado && usuarioLogado.username) {
            // USUÁRIO LOGADO - mostra dropdown, esconde botão login
            loginBtn.classList.add("d-none");
            perfilDropdown.classList.remove("d-none");
            usernameLabel.textContent = usuarioLogado.username;
          } else {
            // USUÁRIO NÃO LOGADO - mostra botão login, esconde dropdown
            loginBtn.classList.remove("d-none");
            perfilDropdown.classList.add("d-none");
          }
        } catch (error) {
          console.error("Erro ao verificar login:", error);
          // Em caso de erro, força estado não logado
          loginBtn.classList.remove("d-none");
          perfilDropdown.classList.add("d-none");
          sessionStorage.removeItem("usuarioLogado");
        }
      }

      // Configuração dos event listeners
      if (loginBtn) {
        loginBtn.addEventListener("click", function (e) {
          e.preventDefault();
          window.location.href = "./public/login.html";
        });
      }

      if (logoutBtn) {
        logoutBtn.addEventListener("click", function (e) {
          e.preventDefault();
          sessionStorage.removeItem("usuarioLogado");
          window.location.href = "index.html";
        });
      }

      // Verifica o estado inicial
      atualizarEstadoLogin();

      // Sidebar collapse (mantido do código original)
      const openBtn = document.getElementById("openSidebarBtn");
      const collapseBtn = document.getElementById("collapseSidebarBtn");
      const sidebar = document.querySelector(".sidebar");
      if (openBtn) openBtn.addEventListener("click", () => sidebar.classList.toggle("collapsed"));
      if (collapseBtn) collapseBtn.addEventListener("click", () => sidebar.classList.toggle("collapsed"));

    })();


    /* =========================
    Charts (Consumo de Dados do Backend)
    ========================= */
    (function () {
      // --------------------------------------------------------------------------------
      // ATENÇÃO: Ajuste a URL conforme seu ambiente.
      // --------------------------------------------------------------------------------
      const BASE_URL = 'http://backend-api:9090'; // Use o nome do serviço Docker + porta interna

      // Endpoints que esperamos no backend:
      const CONSUMO_MENSAL_URL = `${BASE_URL}/api/consumo/mensal`;
      const CONSUMO_TIPO_URL = `${BASE_URL}/api/consumo/tipo`;

      // Função genérica de busca (simplifica o código)
      async function fetchData(url) {
        try {
          const response = await fetch(url);
          if (!response.ok) {
            // Tenta pegar a mensagem de erro do servidor
            const errorDetail = await response.text().catch(() => 'Erro desconhecido');
            throw new Error(`Falha no endpoint ${url}. Status: ${response.status}. Detalhe: ${errorDetail.substring(0, 100)}...`);
          }
          return await response.json();
        } catch (error) {
          console.error(`Erro ao buscar dados de ${url}:`, error);
          return null; // Retorna null em caso de falha
        }
      }

      // ========== 1. GRÁFICO DE CONSUMO MENSAL (LINHA) ==========
      async function carregarConsumoMensal() {
        const ctx = document.getElementById("consumoChart");
        if (!ctx) return;

        // Limpa o gráfico de exemplo (se existir)
        const existingChart = Chart.getChart(ctx);
        if (existingChart) existingChart.destroy();

        ctx.parentNode.style.minHeight = '100px'; // Para mostrar status

        const dataDiv = ctx.parentNode;
        dataDiv.innerHTML = '<p class="text-center text-muted pt-5">Carregando consumo mensal...</p><canvas id="consumoChart"></canvas>';

        const dados = await fetchData(CONSUMO_MENSAL_URL);

        // Reconecta o canvas após a limpeza
        const newCtx = document.getElementById("consumoChart");

        if (dados && dados.labels && dados.data) {
          dataDiv.innerHTML = '<canvas id="consumoChart"></canvas>'; // Limpa status
          // Redefine o contexto para a nova tela
          const chartCtx = document.getElementById("consumoChart").getContext('2d');

          new Chart(chartCtx, {
            type: 'line',
            data: {
              labels: dados.labels, // Ex: ['Jan', 'Fev', 'Mar', ...]
              datasets: [{
                label: 'kWh',
                data: dados.data, // Ex: [120, 110, 140, ...]
                borderWidth: 2,
                borderColor: '#21A67A',
                backgroundColor: 'rgba(33,166,122,0.08)',
                tension: .35,
                pointRadius: 3
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } }
            }
          });
        } else {
          dataDiv.innerHTML = '<p class="text-danger text-center pt-5">Não foi possível carregar dados de Consumo Mensal.</p>';
        }
      }

      // ========== 2. GRÁFICO DE CONSUMO POR TIPO (PIZZA/ROSQUINHA) ==========
      async function carregarConsumoTipo() {
        const ctx2 = document.getElementById("consumoTipoChart");
        if (!ctx2) return;

        const existingChart = Chart.getChart(ctx2);
        if (existingChart) existingChart.destroy();

        // O backend deve retornar: { labels: ['Iluminação', 'Refrigeração', ...], data: [35, 25, ...] }
        const dados = await fetchData(CONSUMO_TIPO_URL);

        if (dados && dados.labels && dados.data) {
          new Chart(ctx2, {
            type: 'doughnut',
            data: {
              labels: dados.labels, // Ex: ['Iluminação', 'Refrigeração', ...]
              datasets: [{
                data: dados.data, // Ex: [35, 25, 20, 20]
                backgroundColor: ['#21A67A', '#5FD3A5', '#F5C26B', '#CDDCDC', '#007A5E', '#C2E5D2']
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              }
            }
          });
        } else {
          // Se falhar, desenha o gráfico de exemplo ou deixa uma mensagem de erro
          // Deixaremos o exemplo com uma nota de falha para preencher o espaço, mas o ideal é deixar mensagem de erro.
          new Chart(ctx2, {
            type: 'doughnut',
            data: {
              labels: ['Falha', 'Carregamento'],
              datasets: [{ data: [1, 1], backgroundColor: ['#FF6384', '#63FF84'] }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: 'bottom', title: { display: true, text: 'Dados Indisponíveis' } } }
            }
          });
        }
      }


      // Inicia o carregamento de todos os componentes
      document.addEventListener("DOMContentLoaded", () => {
        carregarConsumoMensal();
        carregarConsumoTipo();
        // Você faria a mesma lógica para carregar a Tabela e a Lista de Dispositivos!
        // carregarDadosTabela();
      });
    })();
  </script>

</body>

</html>